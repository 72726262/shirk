// lib/data/repositories/auth_repository.dart
import 'package:mmm/data/models/user_model.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class AuthRepository {
  final SupabaseClient _client = Supabase.instance.client;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
  bool _isValidEmail(String email) {
    final emailRegex = RegExp(
      r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$',
    );
    return emailRegex.hasMatch(email.trim());
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  Future<UserModel?> getCurrentUser() async {
    try {
      final currentUser = _client.auth.currentUser;

      if (currentUser != null) {
        final data = await _client
            .from('profiles')
            .select()
            .eq('id', currentUser.id)
            .maybeSingle();

        return data != null ? UserModel.fromJson(data) : null;
      }
      return null;
    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ getCurrentUser: $e');
      return null;
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  Future<UserModel> signIn(String email, String password) async {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!_isValidEmail(email)) {
        throw Exception('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­');
      }

      if (password.isEmpty || password.length < 6) {
        throw Exception('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
      }

      print('ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${email.trim()}');

      final response = await _client.auth.signInWithPassword(
        email: email.trim(),
        password: password,
      );

      print('âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${response.user?.id}');

      if (response.user != null) {
        // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø£Ùˆ Ø£Ù†Ø´Ø¦Ù‡
        var profile = await getUserProfile(response.user!.id);

        if (profile == null) {
          profile = await createUserProfile(
            userId: response.user!.id,
            email: email.trim(),
            fullName: response.user!.userMetadata?['full_name'] ?? 'Ù…Ø³ØªØ®Ø¯Ù…',
            phone: response.user!.phone,
          );
        }

        return profile;
      }

      throw Exception('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } on AuthException catch (e) {
      print('âŒ Ø®Ø·Ø£ Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${e.message}');

      if (e.message.contains('Invalid login credentials')) {
        throw Exception('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      }

      throw Exception('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${e.message}');
    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: $e');
      throw Exception('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
    }
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­
  Future<UserModel> signUp({
    required String email,
    required String password,
    required String fullName,
    String? phone,
  }) async {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!_isValidEmail(email)) {
        throw Exception('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­');
      }

      if (password.length < 6) {
        throw Exception('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
      }

      if (fullName.trim().isEmpty) {
        throw Exception('Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø·Ù„ÙˆØ¨');
      }

      print('ğŸ‘¤ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„: ${email.trim()}');

      // 1. Ø£ÙˆÙ„Ø§Ù‹ ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ auth
      try {
        final existingResponse = await _client.auth.signInWithPassword(
          email: email.trim(),
          password: password,
        );

        if (existingResponse.user != null) {
          print('âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
          final profile = await _getOrCreateProfile(
            userId: existingResponse.user!.id,
            email: email.trim(),
            fullName: fullName.trim(),
            phone: phone?.trim(),
          );
          return profile;
        }
      } catch (e) {
        // Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªØ§Ø¨Ø¹ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
        print('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯');
      }

      // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ auth
      final response = await _client.auth.signUp(
        email: email.trim(),
        password: password,
        data: {'full_name': fullName.trim(), 'phone': phone?.trim()},
      );

      print('âœ… Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${response.user?.id}');

      if (response.user != null) {
        // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        final profile = await _getOrCreateProfile(
          userId: response.user!.id,
          email: email.trim(),
          fullName: fullName.trim(),
          phone: phone?.trim(),
        );

        print('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡/Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ: ${profile.id}');
        return profile;
      }

      throw Exception('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
    } on AuthException catch (e) {
      print('âŒ Ø®Ø·Ø£ Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${e.message}');

      if (e.message.contains('already registered')) {
        throw Exception('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§');
      }

      throw Exception('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${e.message}');
    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: $e');
      throw Exception('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
    }
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø£Ùˆ Ø£Ù†Ø´Ø¦Ù‡
  Future<UserModel> _getOrCreateProfile({
    required String userId,
    required String email,
    required String fullName,
    String? phone,
  }) async {
    try {
      // Ø£ÙˆÙ„Ø§Ù‹: Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
      final existingProfile = await getUserProfile(userId);
      if (existingProfile != null) {
        print('âœ… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„: $userId');
        return existingProfile;
      }

      print('ğŸ“ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: $userId');

      // Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
      try {
        final data = await _client
            .from('profiles')
            .insert({
              'id': userId,
              'email': email,
              'full_name': fullName,
              'phone': phone,
              'role': 'client',
              'kyc_status': 'pending',
              'created_at': DateTime.now().toIso8601String(),
              'updated_at': DateTime.now().toIso8601String(),
            })
            .select()
            .single();

        print('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­');
        return UserModel.fromJson(data);
      } on PostgrestException catch (e) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ (Ù…ÙØªØ§Ø­ Ù…ÙƒØ±Ø±)
        if (e.code == '23505') {
          print(
            'âš ï¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„ÙƒÙ† ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...',
          );

          // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
          await Future.delayed(const Duration(seconds: 1));

          final retryProfile = await getUserProfile(userId);
          if (retryProfile != null) {
            return retryProfile;
          }

          // Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ø£Ù†Ø´Ø¦ Ù…Ù„ÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø¨Ù…Ø¹Ø±Ù Ù…Ø®ØªÙ„Ù
          return await _createProfileWithNewId(
            originalUserId: userId,
            email: email,
            fullName: fullName,
            phone: phone,
          );
        }
        rethrow;
      }
    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ _getOrCreateProfile: $e');
      throw Exception('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ: ${e.toString()}');
    }
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¨Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯
  Future<UserModel> _createProfileWithNewId({
    required String originalUserId,
    required String email,
    required String fullName,
    String? phone,
  }) async {
    try {
      final newUserId =
          '${originalUserId}_${DateTime.now().millisecondsSinceEpoch}';

      print('ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù: $newUserId');

      final data = await _client
          .from('profiles')
          .insert({
            'id': newUserId,
            'email': email,
            'full_name': fullName,
            'phone': phone,
            'role': 'client',
            'kyc_status': 'pending',
            'created_at': DateTime.now().toIso8601String(),
            'updated_at': DateTime.now().toIso8601String(),
          })
          .select()
          .single();

      return UserModel.fromJson(data);
    } catch (e) {
      print('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¬Ø¯ÙŠØ¯: $e');
      throw Exception('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  Future<void> signOut() async {
    try {
      await _client.auth.signOut();
    } catch (e) {
      throw Exception('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ${e.toString()}');
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
  Future<UserModel> updateProfile({
    required String userId,
    String? fullName,
    String? phone,
    String? avatarPath,
  }) async {
    try {
      final updateData = <String, dynamic>{
        'updated_at': DateTime.now().toIso8601String(),
      };

      if (fullName != null) updateData['full_name'] = fullName;
      if (phone != null) updateData['phone'] = phone;
      if (avatarPath != null) updateData['avatar_url'] = avatarPath;

      final data = await _client
          .from('profiles')
          .update(updateData)
          .eq('id', userId)
          .select()
          .single();

      return UserModel.fromJson(data);
    } catch (e) {
      throw Exception('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ: ${e.toString()}');
    }
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
  Future<UserModel?> getUserProfile(String userId) async {
    try {
      final data = await _client
          .from('profiles')
          .select()
          .eq('id', userId)
          .maybeSingle();

      return data != null ? UserModel.fromJson(data) : null;
    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ getUserProfile: $e');
      return null;
    }
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø´Ø®ØµÙŠ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© - Ù„Ù„ØªÙˆØ§ÙÙ‚)
  Future<UserModel> createUserProfile({
    required String userId,
    required String email,
    required String fullName,
    String? phone,
  }) async {
    return await _getOrCreateProfile(
      userId: userId,
      email: email,
      fullName: fullName,
      phone: phone,
    );
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ (KYC)
  Future<void> submitKyc({
    required String userId,
    required String idFrontPath,
    required String idBackPath,
    required String selfiePath,
    String? incomeProofPath,
  }) async {
    try {
      await _client
          .from('profiles')
          .update({
            'kyc_status': 'under_review',
            'kyc_submitted_at': DateTime.now().toIso8601String(),
          })
          .eq('id', userId);
    } catch (e) {
      throw Exception('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚: ${e.toString()}');
    }
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
  Future<void> verifyPhone(String code) async {
    await Future.delayed(const Duration(seconds: 1));
  }

  // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
  Future<void> resendPhoneVerificationCode() async {
    await Future.delayed(const Duration(seconds: 1));
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
  bool get isAuthenticated => _client.auth.currentSession != null;
  String? get currentUserId => _client.auth.currentUser?.id;
}
